/*! backbone.collectionsubset - v0.1.0 - 2012-09-13
* https://github.com/anthonyshort/backbone.collectionsubset
* Copyright (c) 2012 Anthony Short; Licensed MIT */
(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};Backbone.CollectionSubset=function(){function t(e){e==null&&(e={}),e=_.defaults(e,{refresh:!0,triggers:null,filter:function(){return!0},name:null,child:null,parent:null}),this.triggers=e.triggers?e.triggers.split(" "):[],e.child||(e.child=new e.parent.constructor),this.setParent(e.parent),this.setChild(e.child),this.setFilter(e.filter),e.model&&(this.child.model=e.model),e.refresh&&this.refresh(),this.name=e.name}return t.extend=Backbone.Model.extend,t.include=function(t){var n,r,i;for(n in t)r=t[n],e.call(moduleKeywords,n)<0&&(this.prototype[n]||(this.prototype[n]=r));return(i=t.included)!=null&&i.apply(this),this},t.include(Backbone.Events),t.prototype.setParent=function(e){var t,n=this;return(t=this.parent)!=null&&t.off(null,null,this),this.parent=e,this.parent.on("add",this._onParentAdd,this),this.parent.on("remove",this._onParentRemove,this),this.parent.on("reset",this._onParentReset,this),this.parent.on("change",this._onParentChange,this),this.parent.on("dispose",this.dispose,this),this.parent.on("loading",function(){return n.child.trigger("loading")},this),this.parent.on("ready",function(){return n.child.trigger("ready")},this)},t.prototype.setChild=function(e){var t;return(t=this.child)!=null&&t.off(null,null,this),this.child=e,this.child.on("add",this._onChildAdd,this),this.child.on("reset",this._onChildReset,this),this.child.on("dispose",this.dispose,this),this.child.superset=this.parent,this.child.filterer=this,this.child.url=this.parent.url,this.child.model=this.parent.model},t.prototype.setFilter=function(e){var t;return t=function(t){var n,r;return n=e.call(this,t),r=this.parent.filterer?this.parent.filterer.filter(t):!0,n&&r},this.filter=t.bind(this)},t.prototype.refresh=function(e){var t;return e==null&&(e={}),t=this.parent.filter(this.filter),this.child.reset(t,{subset:this}),this.child.trigger("refresh")},t.prototype._replaceChildModel=function(e){var t,n;t=this.child.getByCid(e.cid);if(t===e)return;return _.isUndefined(t)?this.child.add(e,{subset:this}):(n=this.child.indexOf(t),this.child.remove(t),this.child.add(e,{at:n,subset:this}))},t.prototype._onParentAdd=function(e,t,n){if(n.subset===this)return;if(this.filter(e))return this._replaceChildModel(e)},t.prototype._onParentRemove=function(e,t,n){return this.child.remove(e,n)},t.prototype._onParentReset=function(e,t){return this.refresh()},t.prototype._onParentChange=function(e,t){if(!this.triggerMatched(e))return;return this.filter(e)?this.child.add(e):this.child.remove(e)},t.prototype._onChildAdd=function(e,t,n){var r;if(n.subset===this)return;this.parent.add(e),r=this.parent.getByCid(e.cid);if(!r)return;return this.filter(r)?this._replaceChildModel(r):this.child.remove(e)},t.prototype._onChildReset=function(e,t){if(t.subset===this)return;return this.parent.add(this.child.models),this.refresh()},t.prototype.triggerMatched=function(e){var t;return this.triggers.length===0?!0:e.hasChanged()?(t=_.keys(e.changedAttributes()),_.intersection(this.triggers,t).length>0):!1},t.prototype.dispose=function(){var e,t,n,r;if(this.disposed)return;this.trigger("dispose",this),this.parent.off(null,null,this),this.child.off(null,null,this),this.child.dispose(),this.off(),r=["parent","child","options"];for(t=0,n=r.length;t<n;t++)e=r[t],delete this[e];return this.disposed=!0},t}()}).call(this);